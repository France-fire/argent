<!DOCTYPE html>
<html>
<head>
    <title>PubCash avec Liste Admin</title>
    <style>
        body { font-family: Arial, sans-serif; background: #f4f4f4; text-align: center; padding: 20px; }
        .card { background: white; padding: 20px; margin: 20px auto; width: 90%; max-width: 400px; border-radius: 10px; box-shadow: 0 2px 5px rgba(0,0,0,0.2); }
        button { padding: 10px 20px; background: #4CAF50; color: white; border: none; border-radius: 5px; cursor: pointer; }
        button:hover { background: #45a049; }
        input { padding: 10px; width: 90%; margin: 10px 0; }
        .admin-card { background: #ffc107; margin-top: 10px; text-align: left; }
    </style>
</head>
<body>

<h1>Bienvenue sur PubCash</h1>

<div id="login-card" class="card">
    <h3>Connexion</h3>
    <input type="text" id="username" placeholder="Nom d'utilisateur">
    <button onclick="login()">Se connecter</button>
</div>

<div id="app" style="display:none;">
    <h3>Bonjour, <span id="userDisplay"></span>!</h3>
    <h3>Solde: <span id="balance">0</span> FCFA</h3>

    <div class="card">
        <h4>Regarder une pub (10 000 FCFA)</h4>
        <iframe width="250" height="150" src="https://www.youtube.com/embed/dQw4w9WgXcQ" frameborder="0" allowfullscreen></iframe>
        <br><br>
        <button onclick="watchAd()">Confirmer</button>
    </div>

    <div class="card">
        <h4>Retirer via Djamo</h4>
        <button onclick="requestWithdraw()">Demander Retrait</button>
    </div>

    <button onclick="logout()">Déconnexion</button>
</div>

<div id="adminPanel" style="display:none;">
    <h2>Panneau Admin – Demandes de retrait</h2>
    <div id="withdrawList" class="card admin-card">Chargement...</div>
    <button onclick="logout()">Déconnexion Admin</button>
</div>

<script>
const API_URL = "https://sheetdb.io/api/v1/m6htjsxagmzhq";
let currentUser = "";
let currentBalance = 0;

async function login() {
    currentUser = document.getElementById("username").value.trim();
    if (!currentUser) return alert("Entrez un nom d'utilisateur.");

    if (currentUser.toLowerCase() === "admin") {
        document.getElementById("login-card").style.display = "none";
        document.getElementById("adminPanel").style.display = "block";
        loadWithdrawRequests();
        return;
    }

    const response = await fetch(API_URL + "?search=username&equals=" + currentUser);
    const data = await response.json();

    if (data.length > 0) {
        currentBalance = parseInt(data[0].balance) || 0;
    } else {
        await fetch(API_URL, {
            method: "POST",
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ data: [{ username: currentUser, balance: 0, phone: "" }] })
        });
        currentBalance = 0;
    }

    document.getElementById("balance").innerText = currentBalance;
    document.getElementById("userDisplay").innerText = currentUser;
    document.getElementById("login-card").style.display = "none";
    document.getElementById("app").style.display = "block";
}

function logout() {
    location.reload();
}

async function watchAd() {
    alert("Merci d'avoir regardé la pub !");
    currentBalance += 10000;
    document.getElementById("balance").innerText = currentBalance;
    await updateBalance();
}

async function requestWithdraw() {
    if (currentBalance < 10000) return alert("Montant minimum pour retirer : 10 000 FCFA");

    const phone = prompt("Entrez votre numéro Djamo :");
    if (!phone) return alert("Numéro invalide.");

    await fetch(API_URL + "/username/" + currentUser, {
        method: "PATCH",
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ data: { balance: 0, phone: phone } })
    });

    alert("Demande de retrait de " + currentBalance + " FCFA envoyée.");
    currentBalance = 0;
    document.getElementById("balance").innerText = currentBalance;
}

async function updateBalance() {
    await fetch(API_URL + "/username/" + currentUser, {
        method: "PATCH",
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ data: { balance: currentBalance } })
    });
}

async function loadWithdrawRequests() {
    const response = await fetch(API_URL);
    const users = await response.json();
    let html = "";

    users.forEach(user => {
        if (user.phone && user.phone.trim() !== "") {
            html += `<p><strong>Nom:</strong> ${user.username}<br><strong>Numéro Djamo:</strong> ${user.phone}<br><strong>Montant:</strong> ${user.balance} FCFA</p><hr>`;
        }
    });

    document.getElementById("withdrawList").innerHTML = html || "Aucune demande pour le moment.";
}
</script>

</body>
</html>
